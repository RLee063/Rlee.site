<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/12/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-12T13:40:21+09:00">
                2018-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/08/x86汇编语言笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/08/x86汇编语言笔记/" itemprop="url"><x86：从实模式到保护模式>笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-08T12:00:00+09:00">
                2018-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第十章-32位x86处理器编程架构"><a href="#第十章-32位x86处理器编程架构" class="headerlink" title="第十章 32位x86处理器编程架构"></a>第十章 32位x86处理器编程架构</h1><h2 id="10-1-IA-32架构的基本执行环境"><a href="#10-1-IA-32架构的基本执行环境" class="headerlink" title="10.1 IA-32架构的基本执行环境"></a>10.1 IA-32架构的基本执行环境</h2><p>略</p>
<h2 id="10-2-线代处理器的结构和特点"><a href="#10-2-线代处理器的结构和特点" class="headerlink" title="10.2 线代处理器的结构和特点"></a>10.2 线代处理器的结构和特点</h2><h3 id="10-2-1-流水线"><a href="#10-2-1-流水线" class="headerlink" title="10.2.1 流水线"></a>10.2.1 流水线</h3><p>为了提高处理器的执行效率和速度，可以把一条指令的执行过程分解为若干个细小的步骤，并分配给相应的单元来完成。各个单元独立、并行执行，这种执行指令的方法就是流水线技术。</p>
<p><img src="/images/从实模式到保护模式/10_1.png" alt=""></p>
<h3 id="10-2-2-cache高速缓存"><a href="#10-2-2-cache高速缓存" class="headerlink" title="10.2.2 cache高速缓存"></a>10.2.2 cache高速缓存</h3><p>高速缓存是处理器与内存之间的一个静态存储器，用于缓解处理器速度和内存读写速度不匹配的问题。<br>程序运行时往往具有空间局部性，频繁的访问相邻内存的指令和数据。利用这个特性可以把处理器正在访问的内存调出来放在高速缓存中，每次访问内存时首先从高速缓存中检索。</p>
<p><img src="/images/从实模式到保护模式/10_2.png" alt=""></p>
<p>有关高速缓存的更多知识，例如高速缓存算法以及不中惩罚，请移步《深入理解计算机系统》笔记。</p>
<h3 id="10-2-3-乱序执行"><a href="#10-2-3-乱序执行" class="headerlink" title="10.2.3 乱序执行"></a>10.2.3 乱序执行</h3><p><code>支持乱序执行，怎么保证指令的原子性？</code></p>
<p><code>实现上述流水线操作不需要拆分指令？</code></p>
<p>为了实现流水线操作，需要把指令拆分为更小的微操作（micro-operations），例如对寄存器进行操作、访问内存等。这样处理器在适当的时候乱序执行指令就可以提高处理器效率。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov eax, [mem1]</span><br><span class="line">shl eax, <span class="number">5</span></span><br><span class="line">add eax, [mem2]</span><br><span class="line">mov [mem3], eax</span><br></pre></td></tr></table></figure>
<p>第三条指令可以分解为从内存中读取mem2的数值，把eax加上这个数值两个微操作，在执行第二条指令的时候就可以提前从内存中读取mem2的数值。</p>
<h3 id="10-2-4-寄存器重命名"><a href="#10-2-4-寄存器重命名" class="headerlink" title="10.2.4 寄存器重命名"></a>10.2.4 寄存器重命名</h3><p><code>感觉这一个特性是为了乱序执行服务的</code></p>
<p><code>具体算法是怎么实现的？</code></p>
<p>处理器通过对寄存器换名的方式（<code>具体算法书上没有提到，好像是tomasulo算法</code>）来避免WAR（读后写）和WAW（写后写）带来的流水线停顿。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov eax, [mem1]</span><br><span class="line">shl eax, <span class="number">3</span></span><br><span class="line">mov [mem2], eax</span><br><span class="line">mov eax, [mem3]</span><br><span class="line">add eax, <span class="number">2</span></span><br><span class="line">mov [mem4], eax</span><br></pre></td></tr></table></figure>
<p>很明显前三条指令与后三条指令没有关系，但是因为使用了相同的寄存器所以后三条指令必须等待eax释放之后才能执行，通过对后三条指令eax寄存器换名的方式，就可以对上述代码乱序执行。</p>
<h3 id="10-2-5-分支目标预测"><a href="#10-2-5-分支目标预测" class="headerlink" title="10.2.5 分支目标预测"></a>10.2.5 分支目标预测</h3><p>流水线最大的问题就是代码中存在大量分支，例如if语句随时可能让指令流前往任意方向。当遇到转移指令时，后面已经进入流水线的指令都会失效，必须清空流水线，这个代价显然太大了，所以就需要对分支目标进行预测。</p>
<p>从统计学的角度来看，有些事情一旦出现，下一次出现的概率还是很大，例如while循环。在处理器内部，有一个小容量的分支目标缓存器，当处理器执行了一条分支语句之后，在缓存器中就会记录当前指令的地址，分支目标地址，以及本次预测分支的结果。下次再执行到这个分支，处理器就会通过缓存器中的对应条目，预测执行和上一次相同的分支。但如果预测失败了，那么清空流水线，刷新缓存器中的记录，这个代价就比较大。</p>
<p><img src="/images/从实模式到保护模式/10_3.png" alt=""></p>
<h2 id="10-3-32位模式的指令系统"><a href="#10-3-32位模式的指令系统" class="headerlink" title="10.3 32位模式的指令系统"></a>10.3 32位模式的指令系统</h2><p>略</p>
<h1 id="第十一章-进入保护模式"><a href="#第十一章-进入保护模式" class="headerlink" title="第十一章 进入保护模式"></a>第十一章 进入保护模式</h1><h2 id="全局描述符表GDT"><a href="#全局描述符表GDT" class="headerlink" title="全局描述符表GDT"></a>全局描述符表GDT</h2><p>分段模式下需要控制对段的访问，就需要记录下与段相关的信息，每一条记录这样信息的数据结构被称为段描述符（Segment Descriptor），为了存放这些描述符，需要在内存中开辟一个段描述符表。其中最主要的描述符表是全局描述符表（Global Descriptor Table），进入保护模式之前必须要定义全局描述符表。</p>
<p>在进入保护模式之前，处理器必须要知道全局描述符表的位置，为此专门有一个48位寄存器GDTR来存放全局描述符表的信息。</p>
<p><img src="/images/从实模式到保护模式/11_1.png" alt=""></p>
<p>边界数值等于表大小-1，也就是最后一个字节的偏移量。</p>
<p>因为在进入保护模式之前处理器寻址能力只有1MB，所以GDT定义在1MB空间以内，进入保护模式之后可以迁移。</p>
<h2 id="存储器的段描述符"><a href="#存储器的段描述符" class="headerlink" title="存储器的段描述符"></a>存储器的段描述符</h2><p>每个段描述符占八个字节。结构如下：</p>
<p><img src="/images/从实模式到保护模式/11_2.png" alt=""></p>
<p><code>地址被拆开了是历史遗留问题</code></p>
<p>G 位是粒度，用于解释段界限的含义。如果为0则段界限以byte为单位，如果为1则段界限以4kbytes为单位。</p>
<p>D/B 是默认操作数大小/默认桟指针大小或者上部边界。对于代码段，0表示16bits，1表示32bits。对于桟段指明了用SP还是用ESP，上部边界是0XFFFF还是0XFFFFFFFF。</p>
<p>L 是64位代码段标志。</p>
<p>AVL 是保留给软件的位。</p>
<p>P 是段存在位，即是否在内存中。</p>
<p>DPL 是特权级位，用于限制访问。</p>
<p>S 位指定描述符类型，0代表系统段，1代表数据段或者代码段。</p>
<p>TYPE 指示段的属性，数据段和代码段定义不同：</p>
<p><img src="/images/从实模式到保护模式/11_3.png" alt=""></p>
<p>X 代表是否可执行，E 代表数据扩展方向，W 代表是否可写，A 代表最近是否访问。C 代表是否为特权级依从的（是否是一致代码段），R 代表是否是可读的。</p>
<pre><code>个人理解一致非一致代码段就是用来保护系统内核代码的。

1.一致代码段：用户代码可以访问的内核代码，但是内核代码不允许访问用户代码。
2.非一致代码段：只允许同级代码段访问。
</code></pre><p><img src="/images/从实模式到保护模式/11_5.png" alt=""></p>
<h2 id="安装存储器的段描述符并加载GDTR"><a href="#安装存储器的段描述符并加载GDTR" class="headerlink" title="安装存储器的段描述符并加载GDTR"></a>安装存储器的段描述符并加载GDTR</h2><p>GDT的第一个描述符必须是空描述符，毕竟经常会出错把啥啥啥变为0x00000000。<br>lgdt 是把全局描述符表的信息装载到GDTR里面的汇编指令。</p>
<h2 id="A20地址线"><a href="#A20地址线" class="headerlink" title="A20地址线"></a>A20地址线</h2><p>进入保护模式之前还有一个历史遗留问题。</p>
<p>以前最多能访问1MB，只需要20个地址引脚，那么第21个地址引脚就会出现点问题。只有20根地址引脚的时候访问超过0XFFFFF的时候就会变为0x100000，但没有1的地址引脚啊，所以就变成0x0000了。现在有了这个引脚，解决方案暂时是令其衡为零。</p>
<p>可以通过92号中断开关A20地址线。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">in	al, <span class="number">92</span>h</span><br><span class="line"><span class="keyword">or</span> al, <span class="number">00000010b</span>    ;  | 打开 A20 地址线</span><br><span class="line">out	<span class="number">92</span>h, al</span><br><span class="line"></span><br><span class="line">in	al, <span class="number">92</span>h		</span><br><span class="line"><span class="keyword">and</span>	al, <span class="number">11111101b</span>	;  | 关闭 A20 地址线</span><br><span class="line">out	<span class="number">92</span>h, al</span><br></pre></td></tr></table></figure>
<h2 id="保护模式下的内存访问"><a href="#保护模式下的内存访问" class="headerlink" title="保护模式下的内存访问"></a>保护模式下的内存访问</h2><p><code>我不知道为什么会在这里介绍这个知识：CR0寄存器的最后一位就是保护模式和实模式的切换开关，置1进入保护模式</code></p>
<p>不同于8086的访问方式，32位处理器的段寄存器存放的不是段基址，而是段选择子。段选择子存储的是一个索引，当前段在段描述符表中的索引，和一些访问信息。</p>
<p><img src="/images/从实模式到保护模式/11_4.png" alt=""></p>
<p>TI=0时表示段描述符在GDT中，TI=1的时候表示在LDT中。RPL 是请求特权级，请求访问这个段的程序的特权级别。</p>
<p>事实上不是每次访问都会去表中查找，每个段寄存器有他自己的描述符高速缓存器，只有当改变了段选择子的时候才回去表中查找段描述符并且加载到高速缓存器中。以后每次都直接从高速缓存器中取得段描述符。</p>
<p>但实模式并没有GDT表和LDT表哦，所以实模式下改变段寄存器是将段基址左移四位然后送到高速缓存器低20位中。</p>
<h3 id="清空流水线并串行化处理器"><a href="#清空流水线并串行化处理器" class="headerlink" title="清空流水线并串行化处理器"></a>清空流水线并串行化处理器</h3><p><code>jmp的时候已经在流水线中执行了一部分的代码怎么处理?</code></p>
<p><code>汇编指令不具有原子性了?</code></p>
<p>设置CR0寄存器后，其实还有两个问题。</p>
<ol>
<li>段描述符高速缓存器中存的还是实模式的数据。</li>
<li>流水线中的代码和乱序执行未完成的代码可能因为是为了32bits环境编译的，在实模式16bits下译码就会出错。需要清空流水线并串行化处理器。</li>
</ol>
<p>有一个两全其美的方案</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jmp dword SelectorToProtectedModeCode:<span class="number">0</span></span><br><span class="line"></span><br><span class="line">PROTECTED_MODE_CODE:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>需要在全局描述符表中添加PROTECTED_MODE_CODE的描述符，jmp本身会清空流水线串行化处理器，这一条指令还会将SelectorToProtectedModeCode装载到cs中，就会更新高速缓存器，至此完全进入保护模式中。</p>
<p>用dword是为了严谨，因为jmp语句放在16bits的代码段中，但是目标代码段是32bits的，不用dword声明为32bits代码，偏移如果过大就会被截断。</p>
<h1 id="第十二章-存储器的保护"><a href="#第十二章-存储器的保护" class="headerlink" title="第十二章 存储器的保护"></a>第十二章 存储器的保护</h1><p>这一章开始对一个进入保护模式的示例代码进行讲解，有关保护模式的代码实现在《一个操作系统实现》的笔记中，此处略去相关内容。</p>
<h2 id="mov-ds-ax-和-mov-ds-eax"><a href="#mov-ds-ax-和-mov-ds-eax" class="headerlink" title="mov ds, ax 和 mov ds, eax"></a>mov ds, ax 和 mov ds, eax</h2><p>在32bits模式下，对于指令 mov ds, ax， 有些人认为操作数是16位的所以汇编出来的机器码应该加上0x66前缀。这样会浪费一个时钟周期，本书作者认为他们是傻逼，但是为了兼容他们，用 mov ds, eax 的指令来达到同样的效果但是生成的机器码没有0x66前缀。</p>
<h2 id="存储器保护"><a href="#存储器保护" class="headerlink" title="存储器保护"></a>存储器保护</h2><p>在为段寄存器赋值时，会检测是否超过描述符表边界。</p>
<p>在为特定的寄存器赋值时，会检测相关类别，例如只有可以写入的数据段才可以加载入SS段。这里有一个设计：除了CS和SS之外的段寄存器可以赋值0(<code>作者还没讲为什么</code>)。</p>
<h2 id="地址变换时的保护"><a href="#地址变换时的保护" class="headerlink" title="地址变换时的保护"></a>地址变换时的保护</h2><h3 id="代码段执行的保护"><a href="#代码段执行的保护" class="headerlink" title="代码段执行的保护"></a>代码段执行的保护</h3><p>当处理器在某个段内取指令执行时，会检测指令是否跨越了段边界。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 ≤ (EIP + 指令长度 - 1) ≤ 实际使用的段界限</span><br></pre></td></tr></table></figure>
<h3 id="桟操作时的保护"><a href="#桟操作时的保护" class="headerlink" title="桟操作时的保护"></a>桟操作时的保护</h3><p>同样的处理器在桟操作时也会检测。桟段通常属于向下扩展的，段界限的值同向上扩展的（段长度-1）有所不同，和粒度一起决定ESP所能具有的最小值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实际使用的段界限 + 1 ≤ (ESP的内容 - 操作数的长度) ≤ 0XFFFFFFFF</span><br></pre></td></tr></table></figure>
<p><strong><code>为什么对高端地址没有限制？</code></strong> 因为是向下扩展的，桟段一般在内存顶部</p>
<p><strong><code>什么叫做实际使用的段界限就是段内不允许访问的最低端偏移地址</code></strong> 因为是向下扩展的，是定义</p>
<h3 id="数据访问时的保护"><a href="#数据访问时的保护" class="headerlink" title="数据访问时的保护"></a>数据访问时的保护</h3><p>和代码段没啥不同的，就是指令长度变为了操作数的长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 ≤ (EIP + 操作数长度 - 1) ≤ 实际使用的段界限</span><br></pre></td></tr></table></figure>
<h2 id="使用别名"><a href="#使用别名" class="headerlink" title="使用别名"></a>使用别名</h2><p>使用另外声明的操作符指向某个已存在的操作符指向的段，但是可以通过设置不同的类型达到例如写入代码段的功能。</p>
<h2 id="指令们"><a href="#指令们" class="headerlink" title="指令们"></a>指令们</h2><ul>
<li><code>xchg</code> 交换指令，交换两个操作数的内容。</li>
</ul>
<h1 id="第十三章-程序的动态加载和执行"><a href="#第十三章-程序的动态加载和执行" class="headerlink" title="第十三章 程序的动态加载和执行"></a>第十三章 程序的动态加载和执行</h1><p>学习目标：</p>
<ol>
<li>了解保护模式是为操作系统提供的技术，不会给应用程序编程带来负担。</li>
<li>学习操作系统在保护模式下加载和重定位应用程序的一般原理，学习简单的内存动态分配，了解应用程序接口API的简单原理，学习字符串比较算法。</li>
<li>学习新指令：bswap、cpuid、cmovcc、sgdt、movzx、movsx、cmpsb、cmpsw、cmpsd、xlat等。</li>
</ol>
<p>指令：</p>
<pre><code>bswap r32; 字节交换，改变字节序
cpuid; 获得cpu信息
cmovcc; 条件传送指令：避免跳转导致流水线清空，条件转移和传送指令结合的产物
sgdt; lgdt的反指令，获得GDTR内容
movzx r16(32), r/m8(16); 零扩展传送
movsx r16(32), r/m8(16); 符号扩展传送
cmpsb/sw/sd; 字节/字/双字 比较指令
xlat; 查表指令，用al寄存器内容作为ds:ebx(bx)表中偏移返回一字节传回al寄存器。
</code></pre><p>注：本章实现了一个小内核，能够加载执行用户应用程序。代码并未自己实现，主要对这个流程中内核的功能管中窥豹、点到为止。内核的实现也并不是当前操作系统的实现，甚至算不上一个内核。</p>
<h2 id="代码清单"><a href="#代码清单" class="headerlink" title="代码清单"></a>代码清单</h2><ol>
<li>13_1.asm 主引导扇区程序</li>
<li>13_2.asm 微型内核</li>
<li>13_3.asm 用户程序</li>
</ol>
<h2 id="内核的结构、功能和加载"><a href="#内核的结构、功能和加载" class="headerlink" title="内核的结构、功能和加载"></a>内核的结构、功能和加载</h2><h3 id="内核的结构"><a href="#内核的结构" class="headerlink" title="内核的结构"></a>内核的结构</h3><p>本章的例子中用到的内核的结构为：</p>
<ul>
<li><p>内核头部数据</p>
<p>  存放了一些内核长度长度、各个段位置信息，用于引导程序加载时创建内核的段描述符。</p>
</li>
<li><p>公用例程段</p>
<p>  提供了一些功能，可以自己使用也可以提供给用户程序使用。</p>
</li>
<li><p>内核数据段</p>
<p>  内核自己的数据段。</p>
</li>
<li><p>内核代码段</p>
<p>  内核的代码。</p>
</li>
<li><p>尾部</p>
<p>  计算内核长度。</p>
</li>
</ul>
<h3 id="内核的加载"><a href="#内核的加载" class="headerlink" title="内核的加载"></a>内核的加载</h3><p>引导程序首先划分内存，为内核程序划分足够的内存空间，例子中划分0x40000-0x9FFFF都是他的地盘。</p>
<pre><code>0X000A0000往上是ROM BIOS的空间。
</code></pre><p>引导程序建立各个描述符，然后进入32位保护模式，初始化各个段。这一步在前面的章节有提到过。</p>
<p>从约定位置（磁盘的第一扇区）读取内核，因为初始化不知道内核有多大，所以需要根据内核头部判是否还要继续读入其他扇区。</p>
<p>接下来是为内核建立段描述符，公用例程、核心数据段和核心代码段等。将接下来刷新GDTR的描述符表的界限。</p>
<pre><code>因为引导程序和操作系统是一家，所以示例代码中段选择子并没有由引导程序传入内核，而是在内核中声明了常数，这样其实不是很好。

由于lgdt（存放GDTR的内容）的地方在代码段中，但代码段不允许更改，于是用到了别名的方法，有一个4GB数据段描述符跨越了整个内存空间，因为是内核所以无敌！
</code></pre><p>最后通过一个长跳转指令就阔仪啦。</p>
<p><code>jmp far [m];是根据什么设置CS的？</code></p>
<h2 id="在内核中执行"><a href="#在内核中执行" class="headerlink" title="在内核中执行"></a>在内核中执行</h2><p>首先初始化段寄存器DS指向内核数据段，（<code>所以CS是怎么指过来的</code>）</p>
<h2 id="用户程序加载"><a href="#用户程序加载" class="headerlink" title="用户程序加载"></a>用户程序加载</h2><h3 id="用户程序的结构"><a href="#用户程序的结构" class="headerlink" title="用户程序的结构"></a>用户程序的结构</h3><p>用户程序必须要满足一定的结构才能方便内核程序加载时初始化。本例中用户程序结构如下：</p>
<ul>
<li><p>程序头部</p>
<p>  包含程序长度，头部长度，程序入口地址，各个段的信息。</p>
</li>
<li><p>符号地址检索表</p>
<p>  调用内核例程的跳转表。</p>
</li>
<li><p>数据段</p>
</li>
<li><p>代码段</p>
</li>
</ul>
<p>有一点WINDOWS的影子。</p>
<h3 id="计算扇区数"><a href="#计算扇区数" class="headerlink" title="计算扇区数"></a>计算扇区数</h3><p>算法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov eax,[core_buf]                 ;程序尺寸</span><br><span class="line">mov ebx,eax</span><br><span class="line"><span class="keyword">and</span> ebx,<span class="number">0xfffffe00</span>                 ;使之<span class="number">512</span>字节对齐（能被<span class="number">512</span>整除的数， </span><br><span class="line">add ebx,<span class="number">512</span>                        ;低<span class="number">9</span>位都为<span class="number">0</span> </span><br><span class="line">test eax,<span class="number">0x000001ff</span>                ;程序的大小正好是<span class="number">512</span>的倍数吗? </span><br><span class="line">cmovnz eax,ebx                     ;不是。使用凑整的结果</span><br></pre></td></tr></table></figure>
<h3 id="动态内存分配"><a href="#动态内存分配" class="headerlink" title="动态内存分配"></a>动态内存分配</h3><p>读取的应用程序需要分配内存存放，若应用程序申请内存，也需要分配内存。操作系统的内存分配特别复杂，这里暂时就不考虑应用程序申请内存。</p>
<p>维护一个内存指针，每次分配内存的时候就把指针作为内存首地址返回，然后把指针加上程序大小，还要考虑对齐。</p>
<h3 id="段的重定位和描述符的创建"><a href="#段的重定位和描述符的创建" class="headerlink" title="段的重定位和描述符的创建"></a>段的重定位和描述符的创建</h3><p>和加载内核程序类似。</p>
<p>这里有一个小技巧，为了获得GDT的总字节数，将获得的GDT界限加一，用的是指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inc bx</span><br><span class="line">;而不是</span><br><span class="line">inc ebx</span><br></pre></td></tr></table></figure>
<p>在加载过GDTR之后，这样用都是可以的，但是当刚开机时，还没有装载过GDTR。此时GDTR的值是0x00000000FFFF，因为长度为0，所以界限为FFFF，这个时候inc ebx的结果是0x00010000，这个作为偏移量显然不对。而inc bx的结果是0x00000000。</p>
<h3 id="重定位用户程序内的符号地址"><a href="#重定位用户程序内的符号地址" class="headerlink" title="重定位用户程序内的符号地址"></a>重定位用户程序内的符号地址</h3><p>不管是内核程序还是用户程序的重定位表前都有表长的数据，所以只要两层loop循环比较就好了，比较成功后将地址和段描述符直接载入用户程序原来存放符号名称的地方，这一点和WINDOWS我记得是相似的。</p>
<h1 id="第十四章-任务和特权级保护"><a href="#第十四章-任务和特权级保护" class="headerlink" title="第十四章 任务和特权级保护"></a>第十四章 任务和特权级保护</h1><p>学习目标：</p>
<ol>
<li>通过演示如何创建一个任务并使之投入运行来学习任务的概念及其组成要素，包括任务的全局空间和局部空间、TSS、LDT、特权级等。</li>
<li>必须了解特别级不是指任务的特权级，而是指组成任务的各个部分的特权级。</li>
<li>清楚CPL、DPL和RPL的含义，以及不同特权级的控制转移规则。</li>
<li>熟悉调用门的用法。</li>
<li>学习一些新指令：lldt、ltr、pushf/pushfd、popf/popfd、ret n/retf n、arpl等，同时了解jmp和call这样传统指令如何被赋予一些新功能。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/15/游戏编程模式读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/15/游戏编程模式读书笔记/" itemprop="url"><游戏编程模式>笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-15T00:00:00+09:00">
                2018-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读书笔记/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>因为某些原因后半部分看完却并没有写入笔记，已弃坑</code></p>
<h1 id="《游戏编程模式》读书笔记"><a href="#《游戏编程模式》读书笔记" class="headerlink" title="《游戏编程模式》读书笔记"></a>《游戏编程模式》读书笔记</h1><p><strong>前言</strong> : 选择了一个课程设计-写一个RPG游戏（详见github项目：Sakura Song）。一来喜欢游戏，二来为了锻炼一下自己的程序设计能力。提前三个周就拿到题目了，本来想着早一点学点游戏设计模式，到时候写起来方便，结果时间安排的不是很好，书找好了却没有看。自以为懂得什么单一责任原则，开闭原则没有问题（而且看过一个四层游戏框架的blog），到现在写了一个周，大部分的时间都在无尽的重构代码，颇显设计拙劣带来的缺点。于是决定暂停手里的项目，花时间看完这本书之后再对程序代码进行重构。</p>
<h2 id="原方案简介"><a href="#原方案简介" class="headerlink" title="原方案简介"></a>原方案简介</h2><p>游戏总体分为三层：探测层，决策层和执行层。每一层独立出一个类，所有的事件分别继承于三层的父类，例如HeroMove -&gt; Execution，三层分别有一个管理类，维护一个队列，每次有事件应该执行都会先放到队列中，有序的执行。</p>
<p>因为感觉类分的太多，而且对自己很多设计没有理论基础而经常质疑自己的设计，所以决心要看书学习一下。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>重访设计模式  <ol>
<li>命令模式</li>
<li>享元模式</li>
<li>观察者模式</li>
<li>原型模式</li>
<li>单例模式</li>
<li>状态模式</li>
</ol>
</li>
</ol>
<h2 id="1-命令模式"><a href="#1-命令模式" class="headerlink" title="1. 命令模式"></a>1. 命令模式</h2><pre><code>命令是具现化的方法调用。
</code></pre><h3 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h3><p>将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化；对请求排队或记录请求日志，以及支持可撤消的操作。</p>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><p>作者用响应用户输入作为例子，考虑一个处理用户输入的函数：</p>
<p><img src="/images/游戏编程模式/1_1_1.png" alt="1_1"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputHandler::handleInput()</span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">if</span> (isPressed(BUTTON_X)) jump();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_Y)) fireGun();</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_A)) swapWeapon();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_B)) lurchIneffectively();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是很简单的一个实现，转换为命令模式的实现：</p>
<p><img src="/images/游戏编程模式/1_1_2.png" alt="1_2"><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~Command() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JumpCommand</span> :</span> <span class="keyword">public</span> Command</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>: </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123; jump(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireCommand</span> :</span> <span class="keyword">public</span> Command</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123; fireGun(); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在InputHandler中添加命令，再在handleInput中调用命令的excute()函数。handleInput并不知道他调用的是command()的哪一个具体的子类。</p>
<p>这样一来通过一层封装好的命令的中转间接寻址，就可以实现更多的功能。命令模式带来的好处还有：<strong>可以让相应函数更具有普适性（可以处理多个对象）</strong>, <strong>撤销和重做等</strong>。</p>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ol>
<li>菜单按键（这里是GOF里面提到的，但是我具体没有看到他的好处）</li>
<li>//..（这儿是关于《游戏编程模式》里面的疑问）</li>
<li>撤销和重做，需要提供命令记录的地方。</li>
</ol>
<h2 id="2-享元模式"><a href="#2-享元模式" class="headerlink" title="2.享元模式"></a>2.享元模式</h2><h3 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h3><p>共享经济节省内存。</p>
<h3 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h3><p>考虑一个角色在地图上移动，经过不同地皮消耗的体力值不同，要怎么设计维护地皮的数组？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Terrain</span><br><span class="line">&#123; TERRAIN_GRASS,</span><br><span class="line">  TERRAIN_HILL,</span><br><span class="line">  TERRAIN_RIVER</span><br><span class="line">  <span class="comment">// 其他地形</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">World</span></span></span><br><span class="line"><span class="class">&#123;</span><span class="keyword">private</span>:</span><br><span class="line">  Terrain tiles_[WIDTH][HEIGHT];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> World::getMovementCost(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><br><span class="line">&#123; <span class="keyword">switch</span> (tiles_[x][y])</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> TERRAIN_GRASS: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">case</span> TERRAIN_HILL: <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">case</span> TERRAIN_RIVER: <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 其他地形……</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>看到作者给出的示例代码，心里一惊！唉？这不是我的实现方式吗，用数组存储枚举变量，再用switch进行判断！</p>
<pre><code>你知道我的意思了。这可行，但是我觉得很丑
</code></pre><p>行吧，原来是错误示范。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Terrain</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    Terrain(<span class="keyword">int</span> movementCost,</span><br><span class="line">    <span class="keyword">bool</span> isWater,</span><br><span class="line">    Texture texture)</span><br><span class="line">    : movementCost_(movementCost),</span><br><span class="line">    isWater_(isWater),</span><br><span class="line">    texture_(texture)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMovementCost</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> movementCost_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isWater</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> isWater_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Texture&amp; <span class="title">getTexture</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> texture_; &#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> movementCost_;</span><br><span class="line">    <span class="keyword">bool</span> isWater_; Texture texture_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>考虑维护一个地皮示例数组？空间和时间开销未免有一点大。</p>
<p>考虑到每一块地皮都是<strong>固有的</strong>，<strong>上下文无关的</strong>，鉴于此，维护一个地皮指针数组，相同的地皮指向同样的示例，省空间的典范！</p>
<p><img src="/images/游戏编程模式/1_2_1.png" alt="1_2_1"><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">World</span></span></span><br><span class="line"><span class="class">&#123;</span><span class="keyword">private</span>:</span><br><span class="line">  Terrain* tiles_[WIDTH][HEIGHT];</span><br><span class="line">  <span class="comment">// 其他代码……</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><p>重复的相似的东西，可以考虑能否享元。</p>
<h2 id="3-观察者模式"><a href="#3-观察者模式" class="headerlink" title="3. 观察者模式"></a>3. 观察者模式</h2><h3 id="意图-1"><a href="#意图-1" class="headerlink" title="意图"></a>意图</h3><p>很多地方可能都对某些特定的事件感兴趣。</p>
<h3 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h3><pre><code>观察者模式是应用最广泛和最广为人知的GoF模式
</code></pre><p>作者花了相当大的篇幅来对<strong>观察者模式</strong>进行讲述，吓得我只能理解前面的皮毛，对于后面实现以后考虑的问题，暂时不做深入了解（例如：观察者的销毁）。</p>
<p>在这里，作者用游戏中的成就系统作为例子进行介绍。假定有一个成就叫做：从高空坠落。没有哪个写物理引擎的程序员愿意在自己优美的代码里面嵌入一段判断成就的代码，这个时候就可以引入观察者模式。</p>
<p><img src="/images/游戏编程模式/1_3_1.png" alt="1_3_1"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Physics::updateEntity(Entity&amp; entity)</span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">bool</span> wasOnSurface = entity.isOnSurface();</span><br><span class="line">    entity.accelerate(GRAVITY);</span><br><span class="line">    entity.update();</span><br><span class="line">    <span class="keyword">if</span> (wasOnSurface &amp;&amp; !entity.isOnSurface())</span><br><span class="line">    &#123;</span><br><span class="line">    notify(entity, EVENT_START_FALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要在物理引擎中维护一个观察者链表，每当有特定事件发生的时候，就给链表中的每个观察者发一个信号，观察者接收到信号后，判断是否是属于自己的信号如果是属于自己的信号就执行相应的操作，这样就提供了一套类与类之间的通知系统。</p>
<h3 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h3><ol>
<li>有很多东西对很多东西感兴趣（XP）</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/17/再看链接WIN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/再看链接WIN/" itemprop="url">再看链接(link)-WINDOWS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T19:30:00+09:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>引言：之前看深入理解操作系统的时候了解了一些关于链接器的知识，但是书上讲得比较浅略，一直对有些地方有疑惑，这次趁着bitman的任务，再次对链接器进行学习。</p>
<p>链接器，主要完成两个工作，符号解析和重定位，其中我认为最关键的就是<strong>找到符号的引用和定义的地址</strong>，为什么这么说，符号解析无非是将引用和定义关联，如果发现未定义则链接失败，重定位就是把引用该符号的地方的代码重定位到定义的位置，所以这篇随笔主要围绕各种情况如何确定符号的引用和定义地址这个问题。</p>
<h3 id="一个-obj文件"><a href="#一个-obj文件" class="headerlink" title="一个.obj文件"></a>一个.obj文件</h3><p>对于编译生成一个.obj的情况，符号的引用和定义全在一个.obj文件中可以找到。编译出来的.obj文件中引用位置数据为0x00000000，此时.obj文件结构大概是这样的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_FILE_HEADER；</span><br><span class="line">IMAGE_SECTION_HEADER[];</span><br><span class="line">SECTION[];</span><br><span class="line">IMAGE_RELOCATION;</span><br><span class="line">IMAGE_SYMBOL_TABLE;</span><br><span class="line">IMAGE_SYMBOL_STRING_TABLE;</span><br></pre></td></tr></table></figure>
<p>在IMAGE_SECTION_HEADER中有两个属性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">  DWORD PointerToRelocations;</span><br><span class="line">  WORD  NumberOfRelocations;</span><br><span class="line">  ...</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>
<p>PointerToRelocations就是这个段所拥有的符号引用在IMAGE_RELOCATION段中的开始偏移，NumberOfRelocations则是条目。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IMAGE_RELOCATION</span>&#123;</span></span><br><span class="line">    DWORD RVA;</span><br><span class="line">    DWORD symbolTableIndex;</span><br><span class="line">    WORD type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于每一个符号<strong>引用</strong>都会在relocation段中生成一个条目，RVA就是该符号在某个段（SECTION_HEADER中记录）的偏移。由此确立了引用的位置，Type可以区别是相对引用（偏移）还是绝对引用（地址），symbolTableIndex是该引用在symbolTable里面的下标，符号的定义信息都包含在symbolTable里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct symbol&#123;</span><br><span class="line">    union m&#123;</span><br><span class="line">        char shortName[8];</span><br><span class="line">        struct &#123;</span><br><span class="line">            int longName = 0；</span><br><span class="line">            u_int offsetIntoStringTable;</span><br><span class="line">        &#125; longName;</span><br><span class="line">        struct &#123;</span><br><span class="line">            u_int Length;</span><br><span class="line">            u_short numberOfRelocations;</span><br><span class="line">            u_short numberOfLinenumbers;</span><br><span class="line">        &#125;d;</span><br><span class="line">    &#125;</span><br><span class="line">    u_int value;</span><br><span class="line">    u_short sectionNumber;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>前八个字节是名字，8字节以内的shortName会直接存储，8字节以上的longName会把前4字节置0，后四字节是该名字字符串在stringTable中的偏移。sectionNumber是指出该符号<strong>定义</strong>在那个section中，value是该符号的段内偏移。</p>
<h3 id="多个-obj文件"><a href="#多个-obj文件" class="headerlink" title="多个.obj文件"></a>多个.obj文件</h3><p>这次考虑main函数引用另外一个cpp中的符号，同样的所有引用位置是0x0，relocation表中记录了引用信息，在symbolTable里，也有相应的所有符号信息，包括外部定义的符号，但是外部定义符号的sectionNum值等于0（猜测这是区分内部定义外部定义的条件），于是链接器记录该未定义符号，在下一个文件的符号表中寻找，找不到则报错。</p>
<h3 id="与静态库-lib链接"><a href="#与静态库-lib链接" class="headerlink" title="与静态库.lib链接"></a>与静态库.lib链接</h3><p>与静态库的链接其实和多个.obj文件链接无2，无非是打了个包。.lib文件中包含了所有的.obj文件，遍历寻找即可。</p>
<h3 id="与动态库进行链接"><a href="#与动态库进行链接" class="headerlink" title="与动态库进行链接"></a>与动态库进行链接</h3><p>动态库与静态库不同的是，不能在载入前确定函数地址，第一次链接以后对函数的调用会指向一个IAT表，然后在加载器加在后调用动态连接器填写IAT表。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/02/管道控制telnet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/管道控制telnet/" itemprop="url">管道控制telnet</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-02T22:44:00+09:00">
                2018-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自娱自乐/" itemprop="url" rel="index">
                    <span itemprop="name">自娱自乐</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>前言</strong></p>
<p>上一篇随笔介绍了如何通过管道控制一个程序，但是这一套在控制<strong>telnet</strong>的时候意外失效了，CreateProcess执行之后telnet闪退了。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>不修改标准输入输出的话CreateProcess之后程序能被正常执行，可以判断是修改了标准输入输出句柄导致的。为了得到更多信息，用IDA打开telnet分析，找出使程序闪退的语句。</p>
<p><img src="https://wx1.sinaimg.cn/mw690/006xBYIFgy1fpzs8btpfrj30uu0hqdhc.jpg" alt="321"></p>
<p>mian函数的主体逻辑如上，程序最开始调用了GetStdHandle()，并且通过返回值判断是否退出程序，这很关键</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrieves a handle to the specified standard device (standard input, standard output, or standard error).</span></span><br><span class="line"><span class="function">HANDLE WINAPI <span class="title">GetStdHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ DWORD nStdHandle</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>函数返回当前的标准输入输出句柄，由于我们已经用管道替换了，所以返回的应该是我们管道的句柄，通过写一个测试程序可以测试到返回的句柄确实是我们的管道句柄。<br>所以程序并不在最开始的判断处退出。<br>为了更快定位到出错的地方，用GetExitCodeProcess()获得程序返回的值。(然而后来发现这里直接测试下一个函数更快)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Retrieves the termination status of the specified process.</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">GetExitCodeProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HANDLE  hProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_ LPDWORD lpExitCode</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>程序运行中就返回259，其余的数值就是程序退出时的返回值，telnet的错误返回值是-1。回到程序代码，在main中返回-1的话只剩下GetConsoleScreenBufferInfo()函数返回0这一种可能，当然程序在其他地方也可以通过exit(-1)来使程序退出并且返回-1，在IDA中搜索exit并没有发现其他可疑的地方，大胆猜测就是这儿了好吧。写一个测试程序发现果然GetConsoleScreenBufferInfo()不认传进去的管道句柄。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">Retrieves information about the specified console screen buffer.</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">GetConsoleScreenBufferInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HANDLE                      hConsoleOutput,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_ PCONSOLE_SCREEN_BUFFER_INFO lpConsoleScreenBufferInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在函数的介绍页面上并没有看见为什么传管道句柄不行，但是在writeConsole()的介绍里发现writeConsole()在传入的句柄是重定向到其他文件的句柄时会失败，猜测就是这样，因为telnet采用对console的write和read一系列操作，而cmd采用的是writeFile类似的操作。</p>
<blockquote>
<p>WriteConsole fails if it is used with a standard handle that is redirected to a file. If an application processes multilingual output that can be redirected, determine whether the output handle is a console handle (one method is to call the GetConsoleMode function and check whether it succeeds). If the handle is a console handle, call WriteConsole. If the handle is not a console handle, the output is redirected and you should call WriteFile to perform the I/O. Be sure to prefix a Unicode plain text file with a byte order mark. For more information, see Using Byte Order Marks.</p>
</blockquote>
<p>同时也说，可以通过CreateFile返回标准输入输出句柄，于是</p>
<h3 id="解决方案1"><a href="#解决方案1" class="headerlink" title="解决方案1"></a>解决方案1</h3><p>大致思路呢就是不再创建管道，而通过CreateFile创建能够返回标准输入输出句柄的文件来控制telnet，其中主要解决两个问题：1)让telnet不会因为该句柄而拒绝 2)能够通过句柄来控制</p>
<p><strong>让telnet接受</strong></p>
<p>最开始设置telnet的句柄为CreateFile返回的句柄的时候，惊人的被拒绝了，没理由啊，在测试程序里都能接受，难道程序是被调用的就不行了？后来偶然发现在CreateProcess的时候添加一个flag <strong>CREATE_NEW_CONSOLE</strong> 就可以了。</p>
<font color="red" size="3" face="微软雅黑">这个地方其实没有搞懂为什么，也为后面埋下伏笔.</font>

<p><strong>控制</strong></p>
<p>似乎不能用WriteFile和ReadFile来使用标准的返回的句柄，但是查询MSDN可以发现可以通过writeConsoleInput()和ReadOutputBufferCharacters()来实现写入和读出管道类似的功能。ReadOutputBufferCharacters()亲自测试确实能够返回，但是在测试writeConsoleInput()之前陷入了沉思。</p>
<p>很奇怪我明明给被调用程序传的是新建的句柄，但是它还是会在控制程序的console上抢输入输出。MSDN上说如果不新建console就是会抢输入输出，但是我新建console就不接受我的句柄，好像事情变得困难了起来，秉承避重就轻的思想，我放弃了这一条路</p>
<font color="red" size="3" face="微软雅黑">有兴趣的话可以按照我这一条路实现下去，或者你对console有见解，知道我的问题出在哪里也可以告诉我。</font>

<h3 id="解决方案2"><a href="#解决方案2" class="headerlink" title="解决方案2"></a>解决方案2</h3><p>（这条路才是老师想让我们走的路吧喂）仍旧是传入管道句柄通过管道控制，通过HOOK WIN32 API的方式，将基于console的操作变为基于file就好了。<br>实现的方法有很多，我给出一个思路：1)hook所有与write和read相关的api，重定向到管道上去 2)hook getStdHandle让他返回createFile新建的句柄用来应付其他console相关的函数，但是由于write和read需要获取管道句柄，但管道句柄通过getStdHandle返回，所以根据调用getStdHandle的次序返回不同的Handle。搜索发现telnet中只有最开始调用了getStdHandle，那么很简单，第二次以后函数正常工作，第一次第二次就调用createFile创建。<br>emmm说起来很简单，但是想这个逻辑还是花了一点时间，比如最开始想要找到存放handle的全局变量。<br>hook工具使用Detours，有关Detours的介绍传送门：<a href="http://www.cnblogs.com/rlee063/p/8695049.html" target="_blank" rel="noopener">detours的简介与简单使用</a></p>
<h4 id="贴代码咯"><a href="#贴代码咯" class="headerlink" title="贴代码咯"></a>贴代码咯</h4><p><strong>control</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">createShell</span><span class="params">(HANDLE * readH, HANDLE * writeH, PROCESS_INFORMATION * pi)</span> </span>&#123;</span><br><span class="line">	SECURITY_ATTRIBUTES sa = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	sa.nLength = <span class="keyword">sizeof</span>(sa);</span><br><span class="line">	sa.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">	sa.bInheritHandle = TRUE;</span><br><span class="line"></span><br><span class="line">	HANDLE rh1, wh1, rh2, wh2;</span><br><span class="line">	<span class="keyword">if</span> (!CreatePipe(&amp;rh1, &amp;wh1, &amp;sa, <span class="number">1024</span>)) &#123;<span class="comment">//outputpipe</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!CreatePipe(&amp;rh2, &amp;wh2, &amp;sa, <span class="number">1024</span>)) &#123;<span class="comment">//input pipe</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*readH = rh1;</span><br><span class="line">	*writeH = wh2;</span><br><span class="line"></span><br><span class="line">	STARTUPINFOA  si;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;si, <span class="number">0</span>, <span class="keyword">sizeof</span>(si));</span><br><span class="line">	si.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;</span><br><span class="line">	si.wShowWindow = SW_HIDE;</span><br><span class="line">	si.hStdInput = rh2;<span class="comment">//rh2</span></span><br><span class="line">	si.hStdOutput = wh1;<span class="comment">//wh1</span></span><br><span class="line">	si.hStdError = wh1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!DetourCreateProcessWithDllA(<span class="literal">NULL</span>, <span class="string">"C:\\Users\\hasee\\Desktop\\tellnet\\telnet.exe"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, NORMAL_PRIORITY_CLASS|CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, pi, <span class="string">"D:\\Visual_studio_test\\VirusExcercise\\Fortelnet\\detoursTest3\\Debug\\detoursTest3.dll"</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"CreateProcess error!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">printMsg</span><span class="params">(HANDLE readH)</span> </span>&#123;</span><br><span class="line">	WCHAR output[<span class="number">1024</span>] = &#123; <span class="string">'\0'</span> &#125;;</span><br><span class="line">	CHAR outputA[<span class="number">1024</span>] = &#123; <span class="string">'\0'</span> &#125;;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> n;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!PeekNamedPipe(readH, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;n, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">"cannot get msg"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (n == <span class="number">0</span>) </span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!ReadFile(readH, output, n, &amp;n, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">"cannot read file"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			output[n] = <span class="literal">NULL</span>;</span><br><span class="line">			WideCharToMultiByte(CP_ACP, <span class="number">0</span>, output, <span class="number">-1</span>, outputA, n, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; outputA ;</span><br><span class="line">		&#125;</span><br><span class="line">		Sleep(<span class="number">100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HANDLE input = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">	HANDLE readH, writeH;</span><br><span class="line">	CHAR output[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">	output[<span class="number">1023</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	u_long n2;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line">	<span class="keyword">if</span> (!createShell(&amp;readH, &amp;writeH, &amp;pi)) &#123;</span><br><span class="line">		system(<span class="string">"pause"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> 	printMsg(readH);</span><br><span class="line">	WCHAR * cmd = <span class="keyword">new</span> WCHAR[<span class="number">1024</span>];</span><br><span class="line">	u_long n;</span><br><span class="line">	<span class="keyword">int</span> Ecode;</span><br><span class="line">	COORD a;</span><br><span class="line">	a.X = <span class="number">0</span>;</span><br><span class="line">	a.Y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	WCHAR *tempB[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		ReadConsoleW(input, cmd, <span class="number">1024</span>, &amp;n2, <span class="literal">NULL</span>);<span class="comment">//ReadConsole</span></span><br><span class="line">		WriteFile(writeH, cmd, n2*<span class="number">2</span>, &amp;n, <span class="literal">NULL</span>);<span class="comment">//write pipe</span></span><br><span class="line">		<span class="keyword">if</span> (!printMsg(readH)) &#123;</span><br><span class="line">			TerminateProcess(pi.hProcess, <span class="number">0</span>);</span><br><span class="line">			system(<span class="string">"pause"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>dll</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;detours.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE(WINAPI* OLD_GetStdHandle)(DWORD nStdHandle) = GetStdHandle;</span><br><span class="line"></span><br><span class="line">BOOL(WINAPI * OLD_WriteConsoleW)(HANDLE  hConsoleOutput, <span class="keyword">const</span> VOID *lpBuffer, DWORD   nNumberOfCharsToWrite, LPDWORD lpNumberOfCharsWritten, LPVOID  lpReserved) = WriteConsoleW;</span><br><span class="line"></span><br><span class="line">BOOL(WINAPI * OLD_ReadConsoleInputW)(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead) = ReadConsoleInputW;</span><br><span class="line"></span><br><span class="line">BOOL(WINAPI * OLD_ReadConsoleInputA)(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead) = ReadConsoleInputA;</span><br><span class="line"></span><br><span class="line">BOOL(WINAPI * OLD_ReadConsoleW)(HANDLE  hConsoleInput, LPVOID  lpBuffer, DWORD   nNumberOfCharsToRead, LPDWORD lpNumberOfCharsRead, PCONSOLE_READCONSOLE_CONTROL  pInputControl) = ReadConsoleW;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE WINAPI <span class="title">NEW_GetStdHandle</span><span class="params">(DWORD nStdHandle)</span> </span>&#123;</span><br><span class="line">	HANDLE ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (c &lt; <span class="number">2</span> ) &#123;</span><br><span class="line">		SECURITY_ATTRIBUTES sa;</span><br><span class="line">		sa.nLength = <span class="keyword">sizeof</span>(sa);</span><br><span class="line">		sa.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">		sa.bInheritHandle = TRUE;</span><br><span class="line">		<span class="keyword">if</span> (nStdHandle == STD_INPUT_HANDLE) &#123;</span><br><span class="line">			ret = CreateFileA(<span class="string">"CONIN$"</span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, &amp;sa, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			ret = CreateFileA(<span class="string">"CONOUT$"</span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_WRITE, &amp;sa, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		c++;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		ret = OLD_GetStdHandle(nStdHandle);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NEW_WriteConsoleW</span><span class="params">(HANDLE  hConsoleOutput, <span class="keyword">const</span> VOID *lpBuffer, DWORD   nNumberOfCharsToWrite, LPDWORD lpNumberOfCharsWritten, LPVOID  lpReserved)</span> </span>&#123;</span><br><span class="line">	HANDLE wPip = GetStdHandle(STD_OUTPUT_HANDLE);</span><br><span class="line">	WriteFile(wPip, lpBuffer, nNumberOfCharsToWrite*<span class="number">2</span>, lpNumberOfCharsWritten, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NEW_ReadConsoleInputW</span><span class="params">(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead)</span> </span>&#123;</span><br><span class="line">	HANDLE rPip = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">	ReadFile(rPip, MultiBytes, nLength, lpNumberOfEventsRead, <span class="literal">NULL</span>);</span><br><span class="line">	*lpNumberOfCharsRead /= <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NEW_ReadConsoleInputA</span><span class="params">(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> wideChar[<span class="number">1024</span>];</span><br><span class="line">	HANDLE rPip = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">	ReadFile(rPip, wideChar, nLength, lpNumberOfEventsRead, <span class="literal">NULL</span>);</span><br><span class="line">	DWORD dwNum = MultiByteToWideChar (CP_ACP, <span class="number">0</span>, wideChar, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	MultiByteToWideChar(CP_ACP, <span class="number">0</span>, wideChar, <span class="number">-1</span>, lpBuffer, dwNum);</span><br><span class="line">	*lpNumberOfCharsRead *= <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NEW_ReadConsoleW</span><span class="params">(HANDLE  hConsoleInput, LPVOID  lpBuffer, DWORD   nNumberOfCharsToRead, LPDWORD lpNumberOfCharsRead, PCONSOLE_READCONSOLE_CONTROL  pInputControl)</span> </span>&#123;</span><br><span class="line">	HANDLE rPip = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">	ReadFile(rPip, lpBuffer, nNumberOfCharsToRead, lpNumberOfCharsRead, <span class="literal">NULL</span>);</span><br><span class="line">	*lpNumberOfCharsRead /= <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DetourRestoreAfterWith();</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_WriteConsoleW, NEW_WriteConsoleW);</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_ReadConsoleInputW, NEW_ReadConsoleInputW);</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_ReadConsoleInputA, NEW_ReadConsoleInputA);</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_ReadConsoleW, NEW_ReadConsoleW);</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_GetStdHandle, NEW_GetStdHandle);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_WriteConsoleW, NEW_WriteConsoleW);</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_ReadConsoleInputW, NEW_ReadConsoleInputW);</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_ReadConsoleInputA, NEW_ReadConsoleInputA);</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_ReadConsoleW, NEW_ReadConsoleW);</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_GetStdHandle, NEW_GetStdHandle);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">					 )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">		Hook();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">		UnHook();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/02/管道/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/管道/" itemprop="url">管道简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-02T22:40:00+09:00">
                2018-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="什么是管道"><a href="#什么是管道" class="headerlink" title="什么是管道"></a>什么是管道</h4><p><a href="https://baike.baidu.com/item/%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93/8327414?fr=aladdin" target="_blank" rel="noopener">百度百科-命名管道</a></p>
<h4 id="通过管道控制cmd"><a href="#通过管道控制cmd" class="headerlink" title="通过管道控制cmd"></a>通过管道控制cmd</h4><p>思路大概是创建两根管道替换掉被调用程序（cmd）的标准输入和输出，控制程序在A管道中写如数据，让被调用程序从A管道管道中读入数据，而被调用程序的输出数据输出到B管道中供控制程序读入。</p>
<blockquote>
<p>此处有图</p>
</blockquote>
<p><strong>创建管道</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SECURITY_ATTRIBUTES sa = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">sa.nLength = <span class="keyword">sizeof</span>(sa);</span><br><span class="line">sa.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">sa.bInheritHandle = TRUE;</span><br><span class="line"></span><br><span class="line">HANDLE rh1, wh1, rh2, wh2;</span><br><span class="line"><span class="keyword">if</span> (!CreatePipe(&amp;rh1, &amp;wh1, &amp;sa, <span class="number">1024</span>)) &#123;<span class="comment">//outputpipe</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!CreatePipe(&amp;rh2, &amp;wh2, &amp;sa, <span class="number">1024</span>)) &#123;<span class="comment">//input pipe</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">(*readH) = rh1;</span><br><span class="line">(*writeH) = wh2;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Creates an anonymous pipe, and returns handles to the read and write ends of the pipe.</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_    PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_    PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_opt_ LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_     DWORD                 nSize</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>创建进程并替换输入输出</strong></p>
<p>修改si.hStdInput和si.hStdOutput<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">STARTUPINFOA  si;</span><br><span class="line"><span class="built_in">memset</span>(&amp;si, <span class="number">0</span>, <span class="keyword">sizeof</span>(si));</span><br><span class="line">si.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;</span><br><span class="line">si.wShowWindow = SW_HIDE;</span><br><span class="line">si.hStdInput = rh2;<span class="comment">//rh2</span></span><br><span class="line">si.hStdOutput = wh1;<span class="comment">//wh1</span></span><br><span class="line">si.hStdError = wh1;</span><br><span class="line"><span class="keyword">if</span> (!CreateProcessWithDllA(<span class="literal">NULL</span>, <span class="string">"C:\\Users\\hasee\\Desktop\\tellnet\\telnet.exe"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, NORMAL_PRIORITY_CLASS|CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, pi)) &#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"CreateProcess error!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>通过管道控制</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//write pipe</span></span><br><span class="line">WriteFile(writeH, cmd, n2*<span class="number">2</span>, &amp;n, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//read pipe</span></span><br><span class="line">PeekNamedPipe(readH, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;n, <span class="literal">NULL</span>);</span><br><span class="line">ReadFile(readH, output, length, &amp;n, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>这样就可以通过控制程序控制cmd。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/02/Detours/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/Detours/" itemprop="url">Detours简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-02T16:43:00+09:00">
                2018-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="什么是Detours"><a href="#什么是Detours" class="headerlink" title="什么是Detours"></a>什么是Detours</h4><blockquote>
<pre><code>Detours是微软开发的一个函数库，可用于捕获系统API。--百度百科
</code></pre></blockquote>
<p>利用detours可以hook到WIN32的API，原理好像是修改调用API的指令使跳转到用户的函数。（未验证）</p>
<h4 id="Detours的安装"><a href="#Detours的安装" class="headerlink" title="Detours的安装"></a>Detours的安装</h4><p>以vs2015为例<br>下载地址：<a href="https://www.microsoft.com/en-us/research/project/detours/?from=http%3A%2F%2Fresearch.microsoft.com%2Fen-us%2Fprojects%2Fdetours%2F" target="_blank" rel="noopener">https://www.microsoft.com/</a> 我下载的版本是<em>Detours Expressv3.0 Build 343</em> 下载之后是免安装文件，解压就能玩。<br>把所有的的文件拷贝到 ++VS2015/VC++ 目录下面，运行++vs2015兼容命令行工具++,进入目录++vs2015/vc/src++，执行命令<em>nmake</em> 就可以用了。生成的lib文件在++lib.X64++和++lib.X86++文件夹中，在项目中包含就可以了。</p>
<h4 id="Detours的使用"><a href="#Detours的使用" class="headerlink" title="Detours的使用"></a>Detours的使用</h4><h5 id="首先需要制作dll，例如制作hook-WriteConsoleW的dll我们需要如下几步："><a href="#首先需要制作dll，例如制作hook-WriteConsoleW的dll我们需要如下几步：" class="headerlink" title="首先需要制作dll，例如制作hook WriteConsoleW的dll我们需要如下几步："></a>首先需要制作dll，例如制作hook WriteConsoleW的dll我们需要如下几步：</h5><ul>
<li>首先写用户的函数</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL(WINAPI * OLD_WriteConsoleW)(HANDLE  hConsoleOutput, <span class="keyword">const</span> VOID *lpBuffer, DWORD   nNumberOfCharsToWrite, LPDWORD lpNumberOfCharsWritten, LPVOID  lpReserved) = WriteConsoleW;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NEW_WriteConsoleW</span><span class="params">(HANDLE  hConsoleOutput, <span class="keyword">const</span> VOID *lpBuffer, DWORD   nNumberOfCharsToWrite, LPDWORD lpNumberOfCharsWritten, LPVOID  lpReserved)</span> </span>&#123;</span><br><span class="line">	HANDLE wPip = GetStdHandle(STD_OUTPUT_HANDLE);</span><br><span class="line">	WriteFile(wPip, lpBuffer, nNumberOfCharsToWrite*<span class="number">2</span>, lpNumberOfCharsWritten, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后是调用detours的api写绑定和解绑函数  </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DetourRestoreAfterWith();</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line">	DetourAttach((PVOID *)&amp;OLD_WriteConsoleW, NEW_WriteConsoleW);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line">	DetourDetach((PVOID *)&amp;OLD_WriteConsoleW, NEW_WriteConsoleW);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>最后在DllMain中调用Hook()和UnHook()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">					 )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">		Hook();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">		UnHook();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果找不到DllMain请打开工程中的++dllmain.cpp++。<br><strong>一定要有一个导出函数不然之后会报错0xc000007b</strong></p>
<h5 id="然后要将dll加载到exe中"><a href="#然后要将dll加载到exe中" class="headerlink" title="然后要将dll加载到exe中"></a>然后要将dll加载到exe中</h5><p>这儿可以自己写dll注射器，也可以调用detours的CreateProcessWithDll，我采用的方法是后者</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DetourCreateProcessWithDllA(<span class="literal">NULL</span>, <span class="string">"C:\\Users\\hasee\\Desktop\\tellnet\\telnet.exe"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, NORMAL_PRIORITY_CLASS|CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, pi, <span class="string">"D:\\Visual_studio_test\\VirusExcercise\\Fortelnet\\detoursTest3\\Debug\\detoursTest3.dll"</span>, <span class="literal">NULL</span>)；</span><br></pre></td></tr></table></figure>
<p>前面的参数和Winodes api CreateProcess一样，倒数第二个是dll地址，最后一个写NULL就行。</p>
<p>至此每当被调用程序的WriteCosoleW要被执行的时候就会先执行我们的NEW_WriteCosoleW函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/26/netStat逆向分析与实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/netStat逆向分析与实现/" itemprop="url">netStat逆向分析与实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-26T23:29:20+09:00">
                2018-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自娱自乐/" itemprop="url" rel="index">
                    <span itemprop="name">自娱自乐</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>netStat和Fport的功能差不多，据说xp上比fport少某些功能，但是我的xp可能比较特殊，fport的功能netStat上的都有，一头雾水地抓起WIn7的netStat就开始分析。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326224810221-1902021664.png" alt=""></p>
<p>目标是五个功能:</p>
<ul>
<li>本地地址 [ip + 端口]</li>
<li>外部地址 [ip + 端口]</li>
<li>状态</li>
<li>PID</li>
<li>所有权信息</li>
</ul>
<p>还是先通过IDA和OD，找到程序关键的函数 DoConnection()：</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326225358641-324486439.png" alt=""></p>
<p>　主要的逻辑就在这儿，先通过InternalGetTcpTableWithOwnerModule()获取Tcp表，这点和Fport的AllocateAndGetTcpExTableFromStack分厂相似，这两个函数都属于 iphlpapi.dll，只不过后者最高支持xp系统，而前者在xp后才支持。</p>
<p>　　通过OD调试查看输出信息可以确定所有有用的信息应该都在这个表里面，在MSDN上没有查到（能力问题）合适的数据结构，还可以发现输出是在DisplayTcpConnEntry里完成的，每一个while循环输出一个表项，所以确定了while循环的退出条件也就是返回的表的第一个四字节显示了表中表项的个数。最开始以为DisplayTcpConnEntry的参数就是具体的ip、port之类的，后来发现其实是传入了表项的首地址，通过IDA反的C代码可以确定第一个表项是从返回的表偏移两个四字节处开始，并且表项长度为0XA0个字节，由此可以确定数据结构的结构。进入displayTcpConnEntry查看。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326230427735-1484080174.png" alt=""></p>
<p>通过与输出信息的比对可以发现v6为本地地址port，v7为本地地址ip，所以表项偏移一个四字节为本地ip，偏移两个四字节为port的大端存储【第一项√】（事后发现高兴的太早了）。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326230710825-1181398406.png" alt=""></p>
<p>然后是一长串的switch，通过比对函数的返回值发现执行了这个函数之后出现了状态字串（如LISTENLING），然后发现给FormatMessage（）传入适当参数可以返回这个状态字串（这儿偷了个懒没有调用这个接口，通过更改即时的数据获得了TCP表项中的数字与状态的关系）【第三项√】，之后的函数调用发现他喵的有点眼熟啊</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326231150829-201142701.png" alt=""></p>
<p>这他喵的就是传本地ip和port的那个函数啊，大胆猜测是外部地址好吧【第二项√】（还是太天真）。</p>
<p>之后调用了一个output的函数输出了上述的三种信息，继续跟踪发现在DisplayOwnerInfo里面输出了pid和所有权信息，进入</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326231520450-1567036833.png" alt=""></p>
<p>在里面看到一个老朋友，dwProcessId就是pid，而这个参数是函数的形参，再回去看函数调用</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326231602029-1489706174.png" alt=""></p>
<p>哦你他吗就是偏移五个四字节嘛【第四项√】，回到displayOwnerInfo（）</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326231734592-1359646143.png" alt=""></p>
<p>K32GetModuleBaseNameA（）就返回了所有者的那个*.exe的信息【第五项√】，这儿有个判断，如果是svchost.exe或者rundll32.exe就会输出相应的模块信息，用后面的那啥不说的打开一个advapi32.dll然后使用I_QueryTagInformation，这儿偷懒了没做这个功能</p>
<p>至此Tcp表所有信息解析完毕，与此类似的还有Tcp6表、Udp表、Udp6表。感觉马上就可以写程序好吧，但是</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326232555754-1624662696.png" alt=""></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180326232612541-567821359.png" alt=""></p>
<p>傻逼了吧，内网地址外网地址输出千变万化，特别是TCP6、UDP6的输出信息，咋这么奇怪呢。</p>
<p>回到刚才传入ip和port的那个函数，刚才我们只是表面推断了ip和port的存入地址，看来并非所有情况都是如此，OD动态跟进定位字符串获取的API</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180327190126865-140937597.png" alt=""></p>
<p>获取IP字串的逻辑就是这一坨，靠getnameinfo（）</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180327190021414-37463799.png" alt=""></p>
<p>　这个API可以返回host name和service name，返回的字串就存在host里面，通过动态跟踪观察发现netstat在-abno的参数下主要信息就只是通过第一个getnameinfo返回，懒了说实话突然没那个耐心去分析什么情况下会调用其他的getNameInfo，大胆猜测在这儿其他的没用，接下来是确定参数，第一个参数是一个结构体指针比较重要，里面就存放了输入信息，第二个指针是sizeof(struct sockaddr)，第三个参数outputBuffer，第四个参数立即数buffer长度，由于不需要Servicename，五六参数均置为0，flag如果是tcp、udp就是那个什么不说0xB，如果是tcp6、udp6就是0x1b。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180327190810322-1471306505.png" alt=""></p>
<p>Tcp和Udp初始化结构体的函数，可以看出结构体长度16字节，第一个字节的第一个二字节存放0x2，第二个二字节存放端口的大端表示，之后跟的是先前确定存放ip信息的四字节，之后是两个int 0。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180327191033801-1490838981.png" alt=""></p>
<p>TCP6和UDP6的结构体把表项首地址也传进来了，第一个short为23，第二个也是short为端口的网络字节序，之后是表项的头16字节，之后是ip信息的四个字节，一共28个字节。</p>
<p>Ps:在用getNameInfo的时候需要先调用WSAstartup()，不然不能正确返回。</p>
<p>至此分析结束，得差不多就这样</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180327191632955-1329148162.png" alt=""></p>
<p>垃圾代码附上，注释区是天真的区域</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;IPHlpApi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Psapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> _<span class="function">stdcall <span class="title">A</span><span class="params">(<span class="keyword">int</span>**, HANDLE, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> _<span class="function">stdcall <span class="title">B</span><span class="params">(<span class="keyword">int</span>**, HANDLE, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> _<span class="function">stdcall <span class="title">C</span><span class="params">(<span class="keyword">int</span>**, HANDLE, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> _<span class="function">stdcall <span class="title">D</span><span class="params">(<span class="keyword">int</span>**, HANDLE, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddrM</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> v1, v2;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v3, v4, v5;</span><br><span class="line">&#125;SOCKADD;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//void ShowIpAndPort(unsigned int ip, unsigned int port, unsigned int tuFlag, unsigned int p6Flag) &#123;</span></span><br><span class="line"><span class="comment">//    char myIp[0x104];</span></span><br><span class="line"><span class="comment">//    SOCKADD* soc;</span></span><br><span class="line"><span class="comment">//    soc-&gt;v1 = soc-&gt;v2 = soc-&gt;v3 = soc-&gt;v4 = soc-&gt;v5 = 0;</span></span><br><span class="line"><span class="comment">//    if (p6Flag) &#123;</span></span><br><span class="line"><span class="comment">//        soc-&gt;v1 = 0x17;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    else &#123;</span></span><br><span class="line"><span class="comment">//        soc-&gt;v1 = 0x2;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    soc-&gt;v2 = htons(port);</span></span><br><span class="line"><span class="comment">//    soc-&gt;v3 = ip;</span></span><br><span class="line"><span class="comment">//    getnameinfo((const SOCKADDR *)soc, 0x10, myIp, 0x104, 0, 0, tuFlag);</span></span><br><span class="line"><span class="comment">//    cout &lt;&lt; myIp &lt;&lt; ":" &lt;&lt; port &lt;&lt; " ";</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//void ShowInformation(int ipN, int portN, int ipW, int portW, int stat, int pid, int type) &#123;</span></span><br><span class="line"><span class="comment">//    switch (type)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//    case 1:</span></span><br><span class="line"><span class="comment">//        ShowIpAndPort(ipN, portN, 0xB, 0);</span></span><br><span class="line"><span class="comment">//        break;</span></span><br><span class="line"><span class="comment">//    case 2:</span></span><br><span class="line"><span class="comment">//        ShowIpAndPort(portN, 0xB, 1);</span></span><br><span class="line"><span class="comment">//        break;</span></span><br><span class="line"><span class="comment">//    case 3:</span></span><br><span class="line"><span class="comment">//        ShowIpAndPort(portN, 0x1B, 0);</span></span><br><span class="line"><span class="comment">//        break;</span></span><br><span class="line"><span class="comment">//    case 4:</span></span><br><span class="line"><span class="comment">//        ShowIpAndPort(portN, 0x1B, 1);</span></span><br><span class="line"><span class="comment">//        break;</span></span><br><span class="line"><span class="comment">//    default:</span></span><br><span class="line"><span class="comment">//        break;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    //byte* ipn = (byte*)&amp;ipN;</span></span><br><span class="line"><span class="comment">//    //cout &lt;&lt; (u_short)*ipn &lt;&lt; "." &lt;&lt; (u_short)*(ipn + 1) &lt;&lt; "." &lt;&lt; (u_short)*(ipn + 2) &lt;&lt; "." &lt;&lt; (u_short)*(ipn + 3) &lt;&lt; ":";</span></span><br><span class="line"><span class="comment">//    //byte* ipw = (byte*)&amp;ipW;</span></span><br><span class="line"><span class="comment">//    //cout &lt;&lt; (u_short)*ipw &lt;&lt; "." &lt;&lt; (u_short)*(ipw + 1) &lt;&lt; "." &lt;&lt; (u_short)*(ipw + 2) &lt;&lt; "." &lt;&lt; (u_short)*(ipw + 3) &lt;&lt; ":";</span></span><br><span class="line"><span class="comment">//    if (ipW) &#123;</span></span><br><span class="line"><span class="comment">//        if (ipW == 1) &#123;</span></span><br><span class="line"><span class="comment">//            ShowIpAndPort(portW, 0xB, 0);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        else &#123;</span></span><br><span class="line"><span class="comment">//            ShowIpAndPort(portW, 0xB, 1);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    ShowStat(stat);</span></span><br><span class="line"><span class="comment">//    cout &lt;&lt; pid &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">//    ShowName(pid);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">tcpSock</span> &#123;</span></span><br><span class="line">    u_short v1, v2;</span><br><span class="line">    u_int v3, v4, v5;</span><br><span class="line">&#125;TcpSock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">tcp6Sock</span> &#123;</span></span><br><span class="line">    u_short v1, v2;</span><br><span class="line">    u_int v3, v4, v5, v6, v7, v8;</span><br><span class="line">&#125;Tcp6Sock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowStat</span><span class="params">(<span class="keyword">int</span> stat)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stat)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"CLOSED "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"LISTENING "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"SYN_SENT "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"SYN_RECEIVED "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"ESTABLISHED "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"FIN_WAIT_1 "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"FIN_WAIT_2 "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"CLOSE_WAIT "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"CLOSING "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"LAST_ACK "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"TIME_WAIT "</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowName</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Name[<span class="number">40</span>] = &#123; <span class="string">'0'</span> &#125;;</span><br><span class="line">    HANDLE pH = OpenProcess(<span class="number">0x410</span>u, <span class="number">0</span>, pid);</span><br><span class="line">    <span class="keyword">if</span> (pH == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"无法获取!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    GetModuleBaseNameA(pH, <span class="number">0</span>, (LPSTR)Name, <span class="number">256</span>);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; Name &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowTcpIpv4AndPort</span><span class="params">(u_int pid, u_short port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> oIp[<span class="number">0x104</span>];</span><br><span class="line">    TcpSock* so = <span class="keyword">new</span> TcpSock;</span><br><span class="line">    <span class="built_in">memset</span>(so, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line">    so-&gt;v1 = <span class="number">0x2</span>;</span><br><span class="line">    so-&gt;v2 = port;</span><br><span class="line">    so-&gt;v3 = pid;</span><br><span class="line">    getnameinfo((<span class="keyword">const</span> SOCKADDR*)so, <span class="number">0x10</span>, oIp, <span class="number">0x104</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0xb</span>);</span><br><span class="line">    u_short oPort = ntohs(port);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; oIp &lt;&lt; <span class="string">":"</span> &lt;&lt; oPort &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowTcpIpv6AndPort</span><span class="params">(<span class="keyword">int</span> *T, u_int pid, u_short port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> oIp[<span class="number">0x104</span>];</span><br><span class="line">    Tcp6Sock* so = <span class="keyword">new</span> Tcp6Sock;</span><br><span class="line">    <span class="built_in">memset</span>(so, <span class="number">0</span>, <span class="number">0x1c</span>);</span><br><span class="line">    so-&gt;v1 = <span class="number">0x17</span>;</span><br><span class="line">    so-&gt;v2 = port;</span><br><span class="line">    so-&gt;v4 = T[<span class="number">0</span>];</span><br><span class="line">    so-&gt;v5 = T[<span class="number">1</span>];</span><br><span class="line">    so-&gt;v6 = T[<span class="number">2</span>];</span><br><span class="line">    so-&gt;v7 = T[<span class="number">3</span>];</span><br><span class="line">    so-&gt;v8 = pid;</span><br><span class="line">    getnameinfo((<span class="keyword">const</span> SOCKADDR*)so, <span class="number">0x1c</span>, oIp, <span class="number">0x104</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0xb</span>);</span><br><span class="line">    u_short oPort = ntohs(port);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; oIp &lt;&lt; <span class="string">":"</span> &lt;&lt; oPort &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowUdpIpv4AndPort</span><span class="params">(u_int pid, u_short port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> oIp[<span class="number">0x104</span>];</span><br><span class="line">    TcpSock* so = <span class="keyword">new</span> TcpSock;</span><br><span class="line">    <span class="built_in">memset</span>(so, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line">    so-&gt;v1 = <span class="number">0x2</span>;</span><br><span class="line">    so-&gt;v2 = port;</span><br><span class="line">    so-&gt;v3 = pid;</span><br><span class="line">    getnameinfo((<span class="keyword">const</span> SOCKADDR*)so, <span class="number">0x10</span>, oIp, <span class="number">0x104</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1b</span>);</span><br><span class="line">    u_short oPort = ntohs(port);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; oIp &lt;&lt; <span class="string">":"</span> &lt;&lt; oPort &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowUdpIpv6AndPort</span><span class="params">(<span class="keyword">int</span> *T, u_int pid, u_short port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> oIp[<span class="number">0x104</span>];</span><br><span class="line">    Tcp6Sock* so = <span class="keyword">new</span> Tcp6Sock;</span><br><span class="line">    <span class="built_in">memset</span>(so, <span class="number">0</span>, <span class="number">0x1c</span>);</span><br><span class="line">    so-&gt;v1 = <span class="number">0x17</span>;</span><br><span class="line">    so-&gt;v2 = port;</span><br><span class="line">    so-&gt;v4 = T[<span class="number">0</span>];</span><br><span class="line">    so-&gt;v5 = T[<span class="number">1</span>];</span><br><span class="line">    so-&gt;v6 = T[<span class="number">2</span>];</span><br><span class="line">    so-&gt;v7 = T[<span class="number">3</span>];</span><br><span class="line">    so-&gt;v8 = pid;</span><br><span class="line">    getnameinfo((<span class="keyword">const</span> SOCKADDR*)so, <span class="number">0x1c</span>, oIp, <span class="number">0x104</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1b</span>);</span><br><span class="line">    u_short oPort = ntohs(port);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; oIp &lt;&lt; <span class="string">":"</span> &lt;&lt; oPort &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowTcpInformation</span><span class="params">(<span class="keyword">int</span> *Table)</span> </span>&#123;</span><br><span class="line">    ShowTcpIpv4AndPort(Table[<span class="number">1</span>], Table[<span class="number">2</span>]);</span><br><span class="line">    ShowTcpIpv4AndPort(Table[<span class="number">3</span>], Table[<span class="number">4</span>]);</span><br><span class="line">    ShowStat(Table[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; Table[<span class="number">5</span>] &lt;&lt;<span class="built_in">endl</span>;<span class="comment">//pid</span></span><br><span class="line">    ShowName(Table[<span class="number">5</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowTcp6Information</span><span class="params">(<span class="keyword">int</span> *Table)</span> </span>&#123;</span><br><span class="line">    ShowTcpIpv6AndPort(Table, Table[<span class="number">6</span>], Table[<span class="number">5</span>]);</span><br><span class="line">    ShowTcpIpv6AndPort(Table, Table[<span class="number">10</span>], Table[<span class="number">11</span>]);</span><br><span class="line">    ShowStat(Table[<span class="number">12</span>]);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; Table[<span class="number">13</span>] &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//pid</span></span><br><span class="line">    ShowName(Table[<span class="number">13</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowUdpInformation</span><span class="params">(<span class="keyword">int</span> *Table)</span> </span>&#123;</span><br><span class="line">    ShowUdpIpv4AndPort(Table[<span class="number">0</span>], Table[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"*:*"</span> &lt;&lt; <span class="string">"   "</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; Table[<span class="number">2</span>] &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//pid</span></span><br><span class="line">    ShowName(Table[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowUdp6Information</span><span class="params">(<span class="keyword">int</span> *Table)</span> </span>&#123;</span><br><span class="line">    ShowUdpIpv6AndPort(Table, Table[<span class="number">4</span>], Table[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"*:*"</span> &lt;&lt; <span class="string">"   "</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; Table[<span class="number">6</span>] &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//pid</span></span><br><span class="line">    ShowName(Table[<span class="number">6</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"本地地址 外部地址 状态 PID"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    WSADATA wsaData = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> isResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (isResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"WSASTRATUP FAILED!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *lp = <span class="literal">NULL</span>;</span><br><span class="line">    LPCWSTR libraryName = <span class="string">L"IPHLPAPI.DLL"</span>;</span><br><span class="line">    HMODULE libraryM = LoadLibraryW(libraryName);</span><br><span class="line">    A* GetTcpTable = (A*)GetProcAddress(libraryM, <span class="string">"InternalGetTcpTableWithOwnerModule"</span>);</span><br><span class="line">    B* GetTcp6Table = (B*)GetProcAddress(libraryM, <span class="string">"InternalGetTcp6TableWithOwnerModule"</span>);</span><br><span class="line">    C* GetUdpTable = (C*)GetProcAddress(libraryM, <span class="string">"InternalGetUdpTableWithOwnerModule"</span>);</span><br><span class="line">    D* GetUdp6Table = (D*)GetProcAddress(libraryM, <span class="string">"InternalGetUdp6TableWithOwnerModule"</span>);</span><br><span class="line"></span><br><span class="line">    HANDLE hHeap = GetProcessHeap();</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    GetTcpTable(&amp;lp, hHeap, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> TcpCnt = *lp;</span><br><span class="line">    <span class="keyword">int</span> *Tcp;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[Tcp information.]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span>(TcpCnt--) &#123;</span><br><span class="line">        Tcp = lp + <span class="number">2</span> + index;</span><br><span class="line">        ShowTcpInformation(Tcp);</span><br><span class="line">        index += <span class="number">40</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    GetTcp6Table(&amp;lp, hHeap, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> Tcp6Cnt = *lp;    </span><br><span class="line">    <span class="keyword">int</span> *Tcp6;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[Tcp6 information.]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (Tcp6Cnt--) &#123;</span><br><span class="line">        Tcp6 = lp + <span class="number">2</span> + index;</span><br><span class="line">        ShowTcp6Information(Tcp6);</span><br><span class="line">        index += <span class="number">48</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    GetUdpTable(&amp;lp, hHeap, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> UdpCnt = *lp;</span><br><span class="line">    <span class="keyword">int</span> *Udp;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[Udp information.]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (UdpCnt--) &#123;</span><br><span class="line">        Udp = lp + <span class="number">2</span> + index;</span><br><span class="line">        ShowUdpInformation(Udp);</span><br><span class="line">        index += <span class="number">40</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    GetUdp6Table(&amp;lp, hHeap, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> Udp6Cnt = *lp;</span><br><span class="line">    <span class="keyword">int</span> *Udp6;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[Udp6 information.]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (Udp6Cnt--) &#123;</span><br><span class="line">        Udp6 = index + <span class="number">2</span> + lp;</span><br><span class="line">        ShowUdp6Information(Udp6);</span><br><span class="line">        index += <span class="number">44</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/23/fport逆向分析与实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/23/fport逆向分析与实现/" itemprop="url">fport逆向分析与实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-23T23:29:20+09:00">
                2018-03-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自娱自乐/" itemprop="url" rel="index">
                    <span itemprop="name">自娱自乐</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Fport是一个可以在winXP上实现查询端口信息功能的软件。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323154415312-1723706654.png" alt=""></p>
<hr>
<p>首先将文件拖入IDA分析，找到main函数，通过与OD动态分析结合，发现输出信息都在一个keyFunction里完成。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323154714201-135180040.png" alt=""></p>
<p>通过OD发现程序的主体逻辑大概是：Tcp和Udp操作类似，首先GetProcessHeap()获取当前堆，然后调用AllocateAndGetTcpExTableFromStack()，再将其返回信息送入workFunc()加工，最后由msgShow()输出到屏幕上。通过MSDN上查询可以知道：</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323155232856-419694478.png" alt=""></p>
<p>GetProcessHeap 返回当前进程堆句柄。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323155347821-1871046562.png" alt=""></p>
<p>【垃圾博客园写了一大堆没有保存按到鼠标全部没有了！！！！心态爆炸】</p>
<p>　　API的功能是获取Tcp信息，第一个参数是一个指针，存放指向返回的tcpTable的指针，第三个参数是getProcessHeap返回的handle，其他都是立即数。经过调试发现，输出的pid和port信息全在tcpTable里面，通过输出和对workFunc的传参发现该表中结构体占4X6个字节，最后4个字节存放pid，9、10字节存放大端方式的port值。所以大胆推测workFunc只是对信息作一定的处理，最后方便msgShow统一地进行输出。进入workFunc验证</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323164404429-878442263.png" alt=""></p>
<p>看到根据pid获取程序名称，地址（zaigetFileAddress中）的功能也在此实现，stringFunc1应该就是对输出信息的处理。至此想要写出同样功能的程序我们只需要调用一次AllocateAndGetTcpExTableFromStack()即可，但是老师的意思似乎是要让我们分析这个API，于是要进到函数中去。（AllocateAndGetTcpExTableFromStack()是iphlpdll.dll里的）</p>
<p><strong>进入AllocateAndGetTcpExTableFromStack()</strong></p>
<p>　　ps:最开始的时候不知道IDA静态分析dll，用OD动态分析吃了不少苦头不过也增强了看汇编代码的能力。附上几张草稿纸</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323164849229-2022489790.png" alt=""></p>
<p>由于最终目的是要写出同样功能的程序，所以只需要获得所有API的调用情况以及具体参数就可以了。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323165026725-761350012.png" alt=""></p>
<p>函数的关系情况，initUnicodeString为createFile提供文件名，createEvent()为zwDeviceIoControlFile()提供handle，第一次调用的返回值为allocateHeap提供大小，第二次调用zwDeviceIoControlFile()返回了tcpTable于是zwDeviceIoControlFile()就是关键API，搞定了它的参数就可以获得pid和port。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323165320508-915996583.png" alt=""></p>
<p>看上去这是一个和硬件打交道的API，从第二个参数开始讲起，Event就是CreateEvent返回的handle，第三四个是立即数0，第五个是指向PIO_STATUS_BLOCK的指针，这儿没有用，第六个看名字就知道比较关键在此是0x120003，后两个也比较关键Inputbuffer，告诉Api你想要做什么，都是立即数轻易获取，每次调用都不一样，长度是固定的值0x24，outputBuffer也很关键，返回的东西就存在里面，第一次调用长度固定0x3c，allocate长度位于返回buffer最后一个字节，由一系列奇怪的计算获得。第二次传入的参数也就是allocateHeap的长度。</p>
<p>第一个参数Filehandle，由CreateFile返回，看到函数调用关系，每次调用DeviceIoControlFile之前都有CreateFile操作，理所应当的觉得这个参数由之前的createFile决定，但是动态分析的时候发现并不是这样，CreateFIle并没有返回句柄，而且zwDeviceIoControlFile用的是一个全局变量0x3c，这就很奇怪了，那要CreateFIle函数有什么用，全程都没用到。尝试nop掉其中所有对CreateFile的调用，程序居然能够正常出结果！猜测：第一个参数是一个固定的数值0x3c。</p>
<p>于是准备开始写自己的第一版程序，首先是工具，直接用WIN10上面VS2015写出来的程序被报错：不是有效的win32应用程序，于是在设置IDE的时候遇到了一连串的问题，不详细讲了只大概列出来：</p>
<ul>
<li>API函数未定义</li>
<li>API头文件找不到</li>
<li>API符号解析出错，有头文件没有实现，也就是说缺失lib</li>
<li>缺失xp工具集</li>
<li>找不到dll</li>
<li>缺失lib【最后去偷了一个lib居然成了】</li>
<li>…</li>
</ul>
<p>　第一版程序大概就实现了调用zwDeviceIoControlFile，但是！重点！但是！我没有实现createFile，因为我觉得它没用啊，没用我为什么要实现，但发现调用了之后outputBuffer啥都没有你说气人不气人，这个程序不能在win10上跑，所以只能用OD调试，最开始以为是PIO_STATUS_BLOCK的错误，因为我偷懒传递了个null，但后来发现并不是这样，我坚决不加createFile上去，因为在loadLibrabry、getProcAddress之后就直接到了allocateAndGetTcpExTableFromStack()，期间也没有机会调用这个函数，我把他nop之后能够执行说明他并没有什么亂用。</p>
<p>　　后来经过一系列的机缘巧合，我不小心在createFile里面打了一个断点，然后惊人的发现在loadLibrary的时候居然执行了这个函数，而且全局变量0x3c就是在这个时候赋值的（以前看到loadLibrary之后该变量地址就是0x3c坚定的认为他是一个死值），然后手写了一个createFile返回handle供ntDeviceIoControlFile调用就成功返回了。</p>
<p>　　返回的Tcp表是乱序的，api里用一个qsort进行排序，觉得没必要，想着能得到pid和port就行了还要啥自行车啊，没想到埋下了祸根。</p>
<p>　　事故发生的时候，我刚把Udp的部分写完，原理和Tcp类似，获取pid的算法不一样。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323172437280-1745130811.png" alt=""></p>
<p>输出Tcp时候pid和port都是去TcpTable里面找，但是输出Udp的时候pid是在Tcp里找的意思是和Tcp输出时的pid一样，port是在UdpTable里找的。这个时候因为他的是排过序的，我的没有排过序，所以我的程序Udp输出的pid和port对应与他的不一样。</p>
<p>　　又是机缘巧合之下发现IDE可以用来分析dll，于是赶紧拖进去看看cmp函数怎么写的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">CompareTcp6Row</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// edi</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">memcmp</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)a1, (<span class="keyword">const</span> <span class="keyword">char</span> *)a2, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *(_DWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">    v4 = *(_DWORD *)(a2 + <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 != v4 )</span><br><span class="line">      <span class="keyword">return</span> v3 - v4;</span><br><span class="line">    v5 = ntohs(*(_WORD *)(a1 + <span class="number">20</span>));</span><br><span class="line">    v6 = v5 - ntohs(*(_WORD *)(a2 + <span class="number">20</span>));</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">      <span class="keyword">return</span> v6;</span><br><span class="line">    result = <span class="built_in">memcmp</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)(a1 + <span class="number">24</span>), (<span class="keyword">const</span> <span class="keyword">char</span> *)(a2 + <span class="number">24</span>), <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = *(_DWORD *)(a1 + <span class="number">40</span>);</span><br><span class="line">      v4 = *(_DWORD *)(a2 + <span class="number">40</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != v4 )</span><br><span class="line">        <span class="keyword">return</span> v3 - v4;</span><br><span class="line">      v7 = ntohs(*(_WORD *)(a1 + <span class="number">44</span>));</span><br><span class="line">      result = v7 - ntohs(*(_WORD *)(a2 + <span class="number">44</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">CompareUdp6Row</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edi</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">memcmp</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)a1, (<span class="keyword">const</span> <span class="keyword">char</span> *)a2, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *(_DWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">    v4 = *(_DWORD *)(a2 + <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 == v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = ntohs(*(_WORD *)(a1 + <span class="number">20</span>));</span><br><span class="line">      result = v5 - ntohs(*(_WORD *)(a2 + <span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = v3 - v4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这个时候我并没有什么闲心看他，因为我发现这个秘密的时候我也大胆推测得差不多了，知道现在我也没有闲心看他。</p>
<p>　　大胆推测：tcp表按照port升序，udp表首先前四字节升序，再按port升序，这样有一个疑问</p>
<p>　　当Udp表规模比Tcp表大的时候，取到的pid值其实已经超出了tcpTable的有效区域，事实也就是这样</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323173541710-2005767678.png" alt=""></p>
<p>那些6553646和0就是垃圾值。一度怀疑fport本身算法有问题。</p>
<p>附一张自己的程序运行结果：</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180323180714060-680423512.png" alt=""></p>
<p>以及源代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;psapi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line">HANDLE pH;</span><br><span class="line"><span class="keyword">int</span> TcpCnt;</span><br><span class="line"><span class="keyword">int</span> UdpCnt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TcpTable</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> v1, v2, v3, v4, v5, v6;</span><br><span class="line">&#125;TcpTable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UdpTable</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> v1, v2, v3;</span><br><span class="line">&#125;UdpTable;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DtoX</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (((value &amp; <span class="number">0x000000FF</span>) &lt;&lt; <span class="number">24</span>) | ((value &amp; <span class="number">0x0000FF00</span>) &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">        ((value &amp; <span class="number">0x00FF0000</span>) &gt;&gt; <span class="number">8</span>) |</span><br><span class="line">        ((value &amp; <span class="number">0xFF000000</span>) &gt;&gt; <span class="number">24</span>)) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpTcp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* v1, <span class="keyword">const</span> <span class="keyword">void</span>* v2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a1 = DtoX((*(TcpTable*)v1).v3);</span><br><span class="line">    <span class="keyword">int</span> a2 = DtoX((*(TcpTable*)v2).v3);</span><br><span class="line">    <span class="keyword">if</span> (a1 &lt; a2)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmpUdp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* v1, <span class="keyword">const</span> <span class="keyword">void</span>* v2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">const</span> <span class="keyword">int</span>)((*(UdpTable*)v1).v1) &lt; (<span class="keyword">const</span> <span class="keyword">int</span>)((*(UdpTable *)v2).v1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">const</span> <span class="keyword">int</span>)((*(UdpTable*)v1).v1) &gt; (<span class="keyword">const</span> <span class="keyword">int</span>)((*(UdpTable *)v2).v1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> a1 = DtoX((*(UdpTable*)v1).v2);</span><br><span class="line">    <span class="keyword">int</span> a2 = DtoX((*(UdpTable*)v2).v2);</span><br><span class="line">    <span class="keyword">if</span> (a1 &lt; a2) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetTableFromStack</span><span class="params">(<span class="keyword">int</span> * inputBuffer, <span class="keyword">int</span> * outputBuffer, <span class="keyword">int</span> outputBufferLength)</span> </span>&#123;</span><br><span class="line">    HANDLE eventhandle = CreateEvent(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (eventhandle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Create event error"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IO_STATUS_BLOCK iostatus_block;</span><br><span class="line">    NtDeviceIoControlFile(pH, eventhandle, <span class="number">0</span>, <span class="number">0</span>, &amp;iostatus_block, <span class="number">0x120003</span>, inputBuffer, <span class="number">0x24</span>, outputBuffer, outputBufferLength);</span><br><span class="line">    CloseHandle(eventhandle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> * <span class="title">AllocateAndGetUdpTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> input1[<span class="number">9</span>] = &#123; <span class="number">0x401</span>, <span class="number">0</span>, <span class="number">0x200</span>, <span class="number">0x100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> input2[<span class="number">9</span>] = &#123; <span class="number">0x401</span>, <span class="number">0</span>, <span class="number">0x200</span>, <span class="number">0x100</span>, <span class="number">0x102</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> output1[<span class="number">5</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    GetTableFromStack(input1, output1, <span class="number">0x14</span>);</span><br><span class="line">    UdpCnt = output1[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">int</span> TableSize = ((UdpCnt+ <span class="number">0xA</span>) * <span class="number">3</span> + <span class="number">3</span>) * <span class="number">4</span> - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> * ptrToTable = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(TableSize);</span><br><span class="line">    GetTableFromStack(input2, ptrToTable, TableSize);</span><br><span class="line">    <span class="comment">//qsort();</span></span><br><span class="line">    <span class="keyword">return</span> ptrToTable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> * <span class="title">AllocateAndGetTcpTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> input1[<span class="number">9</span>] = &#123; <span class="number">0x400</span>, <span class="number">0</span>, <span class="number">0x200</span>, <span class="number">0x100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> input2[<span class="number">9</span>] = &#123; <span class="number">0x400</span>, <span class="number">0</span>, <span class="number">0x200</span>, <span class="number">0x100</span>, <span class="number">0x102</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> output1[<span class="number">15</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    GetTableFromStack(input1, output1, <span class="number">0x3c</span>);</span><br><span class="line">    TcpCnt = output1[<span class="number">14</span>];</span><br><span class="line">    <span class="keyword">int</span> TableSize = (TcpCnt + <span class="number">0xA</span>) * <span class="number">24</span> + <span class="number">0xc</span> - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> * ptrToTable = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(TableSize);</span><br><span class="line">    GetTableFromStack(input2, ptrToTable, TableSize);</span><br><span class="line">    <span class="comment">//qsort();</span></span><br><span class="line">    <span class="keyword">return</span> ptrToTable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OpenTcpDriver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IO_STATUS_BLOCK ioStB;</span><br><span class="line">    PCWSTR sourceString = <span class="string">L"\\Device\\Tcp"</span>;</span><br><span class="line">    UNICODE_STRING DestinationString;</span><br><span class="line">    RtlInitUnicodeString(&amp;DestinationString, sourceString);</span><br><span class="line">    OBJECT_ATTRIBUTES objAtt;</span><br><span class="line">    objAtt.ObjectName = &amp;DestinationString;</span><br><span class="line">    objAtt.Length = <span class="number">24</span>;</span><br><span class="line">    objAtt.RootDirectory = <span class="number">0</span>;</span><br><span class="line">    objAtt.Attributes = <span class="number">64</span>;</span><br><span class="line">    objAtt.SecurityDescriptor = <span class="number">0</span>;</span><br><span class="line">    objAtt.SecurityQualityOfService = <span class="number">0</span>;</span><br><span class="line">    NtCreateFile(&amp;pH, <span class="number">0x20000000</span>u, &amp;objAtt, &amp;ioStB, <span class="number">0</span>, <span class="number">0x80</span>u, <span class="number">3u</span>, <span class="number">3u</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showInformation</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ProcessName[<span class="number">28</span>] = &#123; <span class="string">'0'</span> &#125;;</span><br><span class="line">    <span class="keyword">char</span> Path[<span class="number">409</span>] = &#123; <span class="string">'0'</span> &#125;;</span><br><span class="line">    <span class="keyword">char</span> PathA[<span class="number">409</span>] = &#123; <span class="string">'0'</span> &#125;;</span><br><span class="line">    HMODULE hModule = <span class="number">0</span>;</span><br><span class="line">    HMODULE hModule2 = <span class="number">0</span>;</span><br><span class="line">    LPDWORD cbNeeded = <span class="number">0</span>;</span><br><span class="line">    LPDWORD cbNeeded2 = <span class="number">0</span>;</span><br><span class="line">    HANDLE processH = OpenProcess(<span class="number">0x410</span>u, <span class="number">0</span>, pid);</span><br><span class="line">    <span class="keyword">if</span> (processH) &#123;</span><br><span class="line">        <span class="keyword">if</span> (EnumProcessModules(processH, &amp;hModule, <span class="number">0x28</span>u, (LPDWORD)&amp;cbNeeded)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (GetModuleBaseNameA(processH, hModule, (LPSTR)ProcessName, <span class="number">0x78</span>u)) &#123;</span><br><span class="line">                HANDLE processH2 = OpenProcess(<span class="number">0x410</span>u, <span class="number">0</span>, pid);</span><br><span class="line">                <span class="keyword">if</span> (processH2) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (EnumProcessModules(processH2, &amp;hModule, <span class="number">4096</span>, (LPDWORD)&amp;cbNeeded2)) &#123;</span><br><span class="line">                        GetModuleFileNameEx(processH2, hModule2, (LPTSTR)Path, <span class="number">260</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    CloseHandle(processH2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            CloseHandle(processH);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    WideCharToMultiByte(CP_ACP, WC_COMPOSITECHECK, (LPCWSTR)Path, <span class="number">-1</span>, (LPSTR)PathA, <span class="number">409</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">" pid: "</span> &lt;&lt; pid &lt;&lt; <span class="string">" port: "</span> &lt;&lt; port &lt;&lt; <span class="string">" ProcessName: "</span> &lt;&lt; ProcessName &lt;&lt; <span class="string">" Path: "</span> &lt;&lt; PathA &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    OpenTcpDriver();</span><br><span class="line">    <span class="keyword">int</span> * pToTcpTable = AllocateAndGetTcpTable();</span><br><span class="line">    qsort(pToTcpTable, TcpCnt, <span class="number">24</span>, cmpTcp);</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"TCP information:"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (TcpCnt--) &#123;</span><br><span class="line">        <span class="keyword">int</span> pid = pToTcpTable[index + <span class="number">5</span>];</span><br><span class="line">        <span class="keyword">int</span> port = DtoX(pToTcpTable[index + <span class="number">2</span>]);</span><br><span class="line">        showInformation(pid, port);</span><br><span class="line">        index += <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> * pToUdpTable = AllocateAndGetUdpTable();</span><br><span class="line">    qsort(pToUdpTable, UdpCnt, <span class="number">12</span>, cmpUdp);</span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> index2 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Udp information:"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (UdpCnt--) &#123;</span><br><span class="line">        <span class="keyword">int</span> pid = pToTcpTable[index + <span class="number">5</span>];</span><br><span class="line">        <span class="keyword">int</span> port = DtoX(pToUdpTable[index2 + <span class="number">1</span>]);</span><br><span class="line">        showInformation(pid, port);</span><br><span class="line">        index2 += <span class="number">3</span>;</span><br><span class="line">        index += <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/07/计算机系统基础-Mooc笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/07/计算机系统基础-Mooc笔记/" itemprop="url"><计算机系统基础>Mooc笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-07T09:36:00+09:00">
                2018-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一周：程序执行概述"><a href="#第一周：程序执行概述" class="headerlink" title="第一周：程序执行概述"></a>第一周：程序执行概述</h1><p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307091114141-142037581.png" alt=""></p>
<p><strong>读数据的过程：</strong> 首先将地址传到MAR中，再由控制总线传入读命令，之后内存取出数据返回到MDR中。</p>
<p><strong>写数据的过程：</strong> 首先将地址传到MAR中，再由控制总线传入写命令，把数据放到MDR中，之后内存会把MDR中的数据写到相应内存中。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307091301743-167965082.png" alt="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307091301743-167965082.png"></p>
<h1 id="第二周：主存储器知识"><a href="#第二周：主存储器知识" class="headerlink" title="第二周：主存储器知识"></a>第二周：主存储器知识</h1><p>基本术语：</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307091901650-1082205787.png" alt="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307091901650-1082205787.png"></p>
<p>内存条组织与主存结构:</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307092323175-462506982.png" alt="3"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307092253212-1145585580.png" alt="4"></p>
<p>例如一个128M的内存条，芯片数决定了一次所能读取的字节数，每个芯片能读取一个字节，假设该内存条有八个芯片，每个芯片有16M，每个芯片都是按8位编址，16M <em> 8 bits = 2^12 </em> 2^12 * 8 bits，所以芯片有12行12列，厚度为8，控制器先发来所取地址的行信息，每个DRAM芯片将对应行整个取出放到行缓冲器中，接下来传来列信息（分两次传入目的减少芯片引脚）芯片在行缓冲期中将对应列8bits取出，所有芯片同时存取，所以在每个芯片中地址是交叉编制不是连续的。</p>
<h1 id="第三周：磁盘驱动器"><a href="#第三周：磁盘驱动器" class="headerlink" title="第三周：磁盘驱动器"></a>第三周：磁盘驱动器</h1><p>磁盘驱动器操作过程:</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307093112820-2017904419.png" alt="5"></p>
<p>磁盘存储器的链接与操作：</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180307093320776-1972756960.png" alt="6"></p>
<p>首先由CPU设置参数，然后发出一条指令启动磁盘驱动器工作，然后CPU执行其他进程；当磁盘驱动器工作完成后向CPU发出一个中断请求，CPU暂停手头的工作来进行数据校验。</p>
<h1 id="第四周：高速缓存概述"><a href="#第四周：高速缓存概述" class="headerlink" title="第四周：高速缓存概述"></a>第四周：高速缓存概述</h1><p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308190202617-404284503.png" alt="1"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308190238550-1406314377.png" alt="2"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308190457810-277360668.png" alt="3"></p>
<p>#tag前还有一位v标记是否放入有效块</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308190751974-199408246.png" alt="4"></p>
<p>行数 = Cache数据区容量 / block 容量</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308190914462-534649806.png" alt="5"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308191029347-900403041.png" alt="6"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308191306695-897919222.png" alt="7"></p>
<p>命中率很关键，能做的只有提高命中率，且提高效果拔群。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308191821703-2059980171.png" alt="8"></p>
<h1 id="第五周：Cache替换算法"><a href="#第五周：Cache替换算法" class="headerlink" title="第五周：Cache替换算法"></a>第五周：Cache替换算法</h1><p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308192159630-543797092.png" alt="8"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308192308192-1188485753.png" alt="9"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308192326902-278623019.png" alt="10"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308192646136-2003617093.png" alt="11"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308192823456-1742486139.png" alt="12"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193215722-733078675.png" alt="13"></p>
<p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193343081-264250986.png" alt="14"></p>
<h1 id="第六周：虚拟存储器"><a href="#第六周：虚拟存储器" class="headerlink" title="第六周：虚拟存储器"></a>第六周：虚拟存储器</h1><p><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193439114-1295589599.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193530109-782290377.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193614799-2041569061.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308193907018-1608899051.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308194120810-366921849.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224259424-3246745.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224431256-1942140542.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224635224-1925863084.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224822534-1074536640.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224847960-1173370014.png" alt=""><br><img src="https://images2018.cnblogs.com/blog/1334944/201803/1334944-20180308224932647-1730532977.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
